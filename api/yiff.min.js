export default async function handler(t,e){const{slug:n,embed:r=!1}=t.query,o=t.headers.host||"";var a=[],i=!0;try{var s=await fetch(`https://${o}/unfiltered.json`);a=await s.json()}catch(t){return console.error("Couldn't grab the unfiltered domain whitelist:",t),e.status(500).json({error:`Couldn't grab the unfiltered domain whitelist: ${t}`})}if(!n)return e.status(400).json({error:"Invalid or missing post ID and extension"});const[p,c]=n.split("."),l=`https://e621.net/posts/${p}.json`;var d;a.includes(o)?(d="e621.net",i=!1):(d="e926.net",i=!0);try{const n=await fetch(l,{headers:{"User-Agent":"e694/1.7"}});if(!n.ok)return e.status(n.status).json({error:"Failed to fetch post data"});const a=await n.json(),s=a?.post,f=c??s.file.ext,$=s.preview?.url,w=`https://${o}/posts/${p}/file.${f}`,v=!("e926.net"==d&&"s"!==s.rating)&&["webm","mp4"].includes(f);var m,h="",u=s.tags.artist.concat(s.tags.contributor??[]),g=["sound_warning","third-party_edit","conditional_dnp"],y=u.filter(t=>!g.includes(t));(s.tags.artist.includes("sound_warning")||s.tags.meta.includes("sound")&&!s.tags.meta.includes("no_sound"))&&(h="\nðŸ”Š Sound Warning! ðŸ”Š");const j=new Date(s.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),b={s:"Safe",q:"Questionable",e:"Explicit"},_={true:" (Safe Mode)",false:""};if("json"===c)return e.status(200).json(a);if(!s||!s.file?.url)return e.status(404).json({error:"Media URL not found in post data"});const x=t.headers.accept||"";if("json+oembed"===c||x.includes("application/json+oembed"))return e.setHeader("Content-Type","application/json+oembed"),e.status(200).json({author_name:`Posted on ${j}\nRating: ${b[s.rating]} â€Ž â€¢ â€Ž Score: ${s.score.total}${h}`,provider_name:v?`Video from ${d} â€¢ e694`:`Image from ${d} â€¢ e694`});if("true"===r){m=1===y.length?`${y[0]}`:`${y[0]} +${y.length-1}`;const t=`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <meta name="viewport" content="width=device-width, initial-scale=1.0">\n          <meta property="theme-color" content="#00709e" />\n          <link rel="icon" href="/favicon.ico" />\n          <meta name="application-name" content="e694">\n          <link rel="alternate" type="application/json+oembed" href="https://${o}/posts/${p}/file.json+oembed">\n          <link rel="apple-touch-icon" href="https://e694.net/icon.png" />\n          <link rel="icon" type="image/png" href="https://e694.net/icon.png">\n          <link rel="icon" type="image/png" sizes="32x32" href="https://e694.net/favicon32.png">\n          <link rel="icon" type="image/png" sizes="16x16" href="https://e694.net/favicon16.png">\n          <meta property="title" content="#${p}" />\n          <meta property="article:published_time" content="${s.created_at}">\n\n          <!-- Open Graph -->\n          <meta property="og:title" content="#${p} by ${m}" />\n          <meta property="og:type" content="${v?"video.other":"article"}" />\n          <meta property="og:site_name" content="${d} via e694${_[i]}">\n          ${v?`\n            <meta property="og:video" content="${w}" />\n            <meta property="og:video:type" content="video/${f}" />\n            <meta property="og:video:width" content="1280" />\n            <meta property="og:video:height" content="720" />\n            <meta property="og:image" content="${$}" />\n          `:`\n            <meta property="og:image" content="${w}" />\n          `}\n\n          <!-- Twitter -->\n          <meta property="twitter:card" content="${v?"player":"summary_large_image"}" />\n          <meta property="twitter:title" content="Post from ${d}" />\n          ${v?`\n            <meta property="twitter:image" content="${$}" />\n            <meta property="twitter:player" content="${w}" />\n            <meta property="twitter:player:width" content="1280" />\n            <meta property="twitter:player:height" content="720" />\n            <meta property="twitter:player:stream" content="${w}" />\n            <meta property="twitter:player:stream:content_type" content="video/${f}" />\n          `:`\n            <meta property="twitter:image" content="${w}" />\n          `}\n          <style>html,body{background:#012e57;}</style>\n        </head>\n        <body>\n            <script>window.location = "https://${d}/posts/${p}"</script>\n        </body>\n        </html>\n      `.trim();return e.setHeader("Content-Type","text/html"),e.status(200).send(t)}const C=await fetch("e926.net"==d&&"s"!==s.rating?"https://e694.net/unsafe.png":s.file.url,{headers:{"User-Agent":"e694/1.7"}});if(!C.ok)return e.status(C.status).json({error:"Failed to fetch image"});const k=await C.arrayBuffer(),H=Buffer.from(k),S=C.headers.get("content-type")||"image/jpeg";return e.setHeader("Cache-Control","public, max-age=300, stale-while-revalidate=60"),e.setHeader("Content-Disposition",`inline; filename="${p}.${f}"`),e.setHeader("Content-Type",S),e.setHeader("Access-Control-Allow-Origin","*"),e.status(200).send(H)}catch(t){return console.error("Error:",t),e.status(500).json({error:"Failed to fetch from API",details:t.message})}}