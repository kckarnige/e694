// @ts-nocheck
export default async function handler(t,e){var n=[];try{var o=await fetch("https://e694.net/whitelist.json");n=await o.json()}catch(t){console.error("Couldn't grab the whitelist:",t)}const{slug:r,embed:a=!1}=t.query;if(!r)return e.status(400).json({error:"Invalid or missing post ID and extension"});const[i,s]=r.split("."),p=`https://e621.net/posts/${i}.json`,c=t.headers.host||"";var l;l=n.includes(c)?"e621.net":"e926.net";try{const n=await fetch(p,{headers:{"User-Agent":"e694/1.4"}});if(!n.ok)return e.status(n.status).json({error:"Failed to fetch post data"});const o=await n.json(),r=o?.post,u=s??r.file.ext,y=r.preview?.url,f=`https://${c}/${i}.${u}`,$=!("e926.net"==l&&"s"!==r.rating)&&["webm","mp4"].includes(u);var m="",d=r.tags.artist.concat(r.tags.contributor??[]),h=["sound_warning","third-party_edit","conditional_dnp"],g=d.filter((t=>!h.includes(t)));(r.tags.artist.includes("sound_warning")||r.tags.meta.includes("sound")&&!r.tags.meta.includes("no_sound"))&&(m="\nðŸ”Š Sound Warning! ðŸ”Š");const w=new Date(r.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),v={s:"Safe",q:"Questionable",e:"Explicit"};if("json"===s)return e.status(200).json(o);if(!r||!r.file?.url)return e.status(404).json({error:"Media URL not found in post data"});const j=t.headers.accept||"";if("json+oembed"===s||j.includes("application/json+oembed"))return e.setHeader("Content-Type","application/json+oembed"),e.status(200).json({author_name:`Posted on ${w}\nRating: ${v[r.rating]} â€Ž â€¢ â€Ž Score: ${r.score.total}${m}`});if("true"===a){const t=`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <meta name="viewport" content="width=device-width, initial-scale=1.0">\n          <meta property="theme-color" content="#00709e" />\n          <link rel="icon" href="/favicon.ico" />\n          <meta name="application-name" content="e694">\n          <link rel="alternate" type="application/json+oembed" href="https://${c}/${i}.json+oembed">\n          <link rel="apple-touch-icon" href="https://e694.net/icon.png" />\n          <link rel="icon" type="image/png" href="https://e694.net/icon.png">\n          <link rel="icon" type="image/png" sizes="32x32" href="https://e694.net/favicon32.png">\n          <link rel="icon" type="image/png" sizes="16x16" href="https://e694.net/favicon16.png">\n          <meta property="title" content="#${i}" />\n\n          \x3c!-- Open Graph --\x3e\n          <meta property="og:title" content="#${i} by ${1===g.length?`${g[0]}`:`${g[0]} +${g.length-1}`}" />\n          <meta property="og:type" content="${$?"video.other":"image"}" />\n          ${$?`\n            <meta property="og:video" content="${f}" />\n            <meta property="og:video:type" content="video/${u}" />\n            <meta property="og:video:width" content="1280" />\n            <meta property="og:video:height" content="720" />\n            <meta property="og:image" content="${y}" />\n            <meta property="og:site_name" content="Video from ${l} â€¢ e694">\n          `:`\n            <meta property="og:image" content="${f}" />\n            <meta property="og:site_name" content="Image from ${l} â€¢ e694">\n          `}\n\n          \x3c!-- Twitter --\x3e\n          <meta property="twitter:card" content="${$?"player":"summary_large_image"}" />\n          <meta property="twitter:title" content="Post from ${l}" />\n          ${$?`\n            <meta property="twitter:image" content="${y}" />\n            <meta property="twitter:player" content="${f}" />\n            <meta property="twitter:player:width" content="1280" />\n            <meta property="twitter:player:height" content="720" />\n            <meta property="twitter:player:stream" content="${f}" />\n            <meta property="twitter:player:stream:content_type" content="video/${u}" />\n          `:`\n            <meta property="twitter:image" content="${f}" />\n          `}\n          <style>html,body{background:#012e57;}</style>\n        </head>\n        <body>\n            <script>window.location = "https://${l}/posts/${i}"<\/script>\n        </body>\n        </html>\n      `.trim();return e.setHeader("Content-Type","text/html"),e.status(200).send(t)}const b=await fetch("e926.net"==l&&"s"!==r.rating?"https://e694.net/unsafe.png":r.file.url,{headers:{"User-Agent":"e694/1.4"}});if(!b.ok)return e.status(b.status).json({error:"Failed to fetch image"});const x=await b.arrayBuffer(),_=Buffer.from(x),k=b.headers.get("content-type")||"image/jpeg";return e.setHeader("Cache-Control","public, max-age=300, stale-while-revalidate=60"),e.setHeader("Content-Disposition",`inline; filename="${i}.${u}"`),e.setHeader("Content-Type",k),e.setHeader("Access-Control-Allow-Origin","*"),e.status(200).send(_)}catch(t){return console.error("Error:",t),e.status(500).json({error:"Failed to fetch from API",details:t.message})}}